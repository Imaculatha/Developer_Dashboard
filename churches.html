<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Churches | CMS Admin</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* All the same CSS as in dashboard.html */
      :root {
        --primary: #4a6fa5;
        --secondary: #166088;
        --light: #f8f9fa;
        --dark: #343a40;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }

      .dashboard {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 250px;
        background-color: var(--primary);
        color: white;
        padding: 20px 0;
        transition: all 0.3s;
      }

      .sidebar-header {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-menu {
        padding: 20px 0;
      }

      .sidebar-menu a {
        display: block;
        padding: 12px 20px;
        color: white;
        text-decoration: none;
        transition: all 0.3s;
      }

      .sidebar-menu a:hover,
      .sidebar-menu a.active {
        background-color: var(--secondary);
      }

      .sidebar-menu i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      .main-content {
        flex: 1;
        padding: 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .table-responsive {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      tr:hover {
        background-color: #f5f5f5;
      }

      .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 14px;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: #3a5a8a;
      }

      .btn-success {
        background-color: var(--success);
        color: white;
      }

      .btn-success:hover {
        background-color: #218838;
      }

      .btn-danger {
        background-color: var(--danger);
        color: white;
      }

      .btn-danger:hover {
        background-color: #c82333;
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
      }

      .status-verified {
        background-color: #d4edda;
        color: #155724;
      }

      .status-pending {
        background-color: #fff3cd;
        color: #856404;
      }

      .search-bar {
        display: flex;
        margin-bottom: 20px;
      }

      .search-bar input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px 0 0 4px;
        border-right: none;
      }

      .search-bar button {
        padding: 10px 15px;
        background-color: var(--primary);
        color: white;
        border: 1px solid var(--primary);
        border-radius: 0 4px 4px 0;
      }

      .form-control {
        display: block;
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .card-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .notification-badge {
        background-color: var(--danger);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        position: absolute;
        top: -5px;
        right: -5px;
      }

      @media (max-width: 768px) {
        .dashboard {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
        }

        .sidebar-menu {
          display: flex;
          overflow-x: auto;
        }

        .sidebar-menu a {
          white-space: nowrap;
        }

        .card-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h2><i class="fas fa-church"></i> CMS Admin</h2>
        </div>
        <div class="sidebar-menu">
          <a href="index.html"
            ><i class="fas fa-tachometer-alt"></i> Dashboard</a
          >
          <a href="churches.html" class="active
            ><i class="fas fa-church"></i> Churches</a
          >
          <a href="users.html"><i class="fas fa-users"></i> Users</a>
          <a href="#"><i class="fas fa-envelope"></i> Messages</a>
          <a href="#"><i class="fas fa-cog"></i> Settings</a>
          <a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h1>Church Management</h1>
          <div class="user-info">
            <span>Admin User</span>
            <div style="position: relative">
              <i class="fas fa-user-circle fa-lg"></i>
            </div>
          </div>
        </div>

        <!-- Filter Options -->
        <div class="card" style="margin-bottom: 20px">
          <div style="display: flex; gap: 15px; flex-wrap: wrap">
            <div style="flex: 1; min-width: 200px">
              <label for="status-filter">Status</label>
              <select id="status-filter" class="form-control">
                <option value="all">All Churches</option>
                <option value="VERIFIED">Verified Only</option>
                <option value="UNVERIFIED">Pending Only</option>
              </select>
            </div>
            <div style="flex: 1; min-width: 200px">
              <label for="date-filter">Registered Date</label>
              <select id="date-filter" class="form-control">
                <option value="ALL">All Time</option>
                <option value="TODAY">Today</option>
                <option value="THIS_WEEK">This Week</option>
                <option value="THIS_MONTH">This Month</option>
                <option value="CUSTOM">Custom Range</option>
              </select>
            </div>
            <div id="custom-date-range" style="flex: 2; min-width: 200px; display: none; align-items: end; gap: 10px;">
              <label for="from-date" style="margin-bottom:0;">From</label>
              <input type="date" id="from-date" class="form-control" style="margin-bottom:0;">
              <label for="to-date" style="margin-bottom:0;">To</label>
              <input type="date" id="to-date" class="form-control" style="margin-bottom:0;">
            </div>
            <div style="flex: 2; min-width: 300px">
              <label for="search">Search Churches</label>
              <div class="search-bar">
                <input
                  type="text"
                  id="search"
                  placeholder="Search by name, location..."
                />
                <button><i class="fas fa-search"></i></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Church List -->
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h3 style="margin: 0">All Registered Churches</h3>
            <div>
              <button class="btn btn-primary" style="margin-right: 10px">
                <i class="fas fa-download"></i> Export
              </button>
              <button class="btn btn-success">
                <i class="fas fa-plus"></i> Add Church
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Church ID</th>
                  <th>Church Name</th>
                  <th>Location</th>
                  <th>Contact</th>
                  <th>Registration Date</th>
                  <th>Verification Key</th>
                  <th>Key Used</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="churches-table-body">
                <!-- Data will be populated here by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div style="display: flex; justify-content: center; margin-top: 20px">
            <nav>
              <ul
                style="
                  display: flex;
                  list-style: none;
                  padding: 0;
                  margin: 0;
                  gap: 5px;
                "
              >
                <li><button class="btn" disabled>Previous</button></li>
                <li>
                  <button
                    class="btn"
                    style="background-color: var(--primary); color: white"
                  >
                    1
                  </button>
                </li>
                <li><button class="btn">2</button></li>
                <li><button class="btn">3</button></li>
                <li><button class="btn">Next</button></li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Helper to format date
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
      }

      // Show/hide custom date range inputs
      document.getElementById("date-filter").addEventListener("change", function () {
        const customRange = document.getElementById("custom-date-range");
        if (this.value === "CUSTOM") {
          customRange.style.display = "flex";
        } else {
          customRange.style.display = "none";
        }
        fetchAndRenderTable();
      });

      // Helper to get date string for filter
      function getDateFilterValue(value) {
        const today = new Date();
        if (value === "today") {
          return today.toISOString().slice(0, 10);
        }
        if (value === "week") {
          // Return Monday of this week
          const day = today.getDay() || 7;
          const monday = new Date(today);
          monday.setDate(today.getDate() - day + 1);
          return monday.toISOString().slice(0, 10);
        }
        if (value === "month") {
          // Return first day of this month
          return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-01`;
        }
        return ""; // all
      }

      // Fetch and populate table with flexible filters
      function fetchAndRenderTable() {
        const statusVal = document.getElementById("status-filter").value;
        const dateFilterVal = document.getElementById("date-filter").value;
        const search = document.getElementById("search").value.trim().toLowerCase();
        const fromDate = document.getElementById("from-date")?.value;
        const toDate = document.getElementById("to-date")?.value;

        let url = "http://localhost:8080/keys?";
        // Status
        url += `status=${statusVal}&`;

        // Date filter
        url += `dateFilterType=${dateFilterVal}`;
        if (dateFilterVal === "CUSTOM") {
          if (fromDate) url += `&fromDate=${fromDate}`;
          if (toDate) url += `&toDate=${toDate}`;
        }

        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            // Filter by search on client side
            let filtered = data;
            if (search) {
              filtered = data.filter(
                (item) =>
                  item.parishName.toLowerCase().includes(search) ||
                  item.parishLocation.toLowerCase().includes(search) ||
                  item.email.toLowerCase().includes(search)
              );
            }

            const tbody = document.getElementById("churches-table-body");
            tbody.innerHTML = "";
            filtered.forEach((item) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
            <td>CH-${item.parishId.toString().padStart(4, "0")}</td>
            <td>${item.parishName}</td>
            <td>${item.parishLocation}</td>
            <td>${item.email}</td>
            <td>${formatDate(item.keyCreatedAt)}</td>
            <td>
              <span class="verification-key" style="cursor:pointer; user-select:all;" title="Click to copy">${item.verificationKey}</span>
              <i class="fas fa-copy copy-key" style="cursor:pointer; margin-left:6px; color:#4a6fa5;" title="Copy key"></i>
            </td>
            <td>${item.keyUsed ? "Yes" : "No"}</td>
            <td>
              <span class="status-badge status-${item.verificationStatus.toLowerCase()}">
                ${item.verificationStatus.charAt(0) + item.verificationStatus.slice(1).toLowerCase()}
              </span>
            </td>
            <td>
              <button class="btn btn-primary btn-sm">
                <i class="fas fa-eye"></i> View
              </button>
              <button class="btn btn-success btn-sm send-key" data-email="${item.email}">
                <i class="fas fa-key"></i> Key
              </button>
            </td>
          `;
              tbody.appendChild(tr);

              // Copy-to-clipboard functionality
              tr.querySelector(".copy-key").addEventListener("click", function () {
                const key = tr.querySelector(".verification-key").textContent;
                navigator.clipboard.writeText(key).then(() => {
                  this.style.color = "#28a745";
                  this.title = "Copied!";
                  setTimeout(() => {
                    this.style.color = "#4a6fa5";
                    this.title = "Copy key";
                  }, 1200);
                });
              });
            });

            // Re-attach send-key event listeners
            document.querySelectorAll(".send-key").forEach((button, idx) => {
              button.addEventListener("click", function () {
                // Find the keyId from the filtered data
                const keyId = filtered[idx].keyId;
                const email = this.getAttribute("data-email");
                if (confirm(`Send verification key to ${email}?`)) {
                  // Disable button and show loading
                  this.disabled = true;
                  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                  this.style.backgroundColor = "#6c757d";

                  fetch(`http://localhost:8080/devdash/send-key/${keyId}`, {
                    method: "GET"
                  })
                    .then(res => {
                      if (!res.ok) throw new Error("Failed to send key");
                      return res.json();
                    })
                    .then(() => {
                      this.innerHTML = '<i class="fas fa-check"></i> Sent';
                      this.style.backgroundColor = "#28a745";
                    })
                    .catch(() => {
                      this.innerHTML = '<i class="fas fa-key"></i> Key';
                      this.style.backgroundColor = "#28a745";
                      this.disabled = false;
                      alert("Failed to send verification key. Please try again.");
                    });
                }
              });
            });
          });
      }

      // Event listeners for filters
      document.getElementById("status-filter").addEventListener("change", fetchAndRenderTable);
      document.getElementById("from-date").addEventListener("change", fetchAndRenderTable);
      document.getElementById("to-date").addEventListener("change", fetchAndRenderTable);
      document.getElementById("search").addEventListener("input", function () {
        // Debounce for search
        clearTimeout(window._searchTimeout);
        window._searchTimeout = setTimeout(fetchAndRenderTable, 300);
      });

      // Initial render
      fetchAndRenderTable();
    </script>
  </body>
</html>
